# 外部硬件中断
1. 外部硬件中断，就是从处理器外面来的中断信号。当外部设备发生错误，或者有数据要传送（比如，从网络中接收到一个针对当前主机的数据包），或者处理器交给它的事情处理完了（比如，打印已经完成）；
2. 中断信号的来源，或者说，产生中断的设备，称方中断源；
3. 外部硬件中断时通过两个信号线引入处理器内部的。从很早的时候起，也就是 8086 处理器的时代，这两根线的名字就叫 NMI 和 INTR。
![image](https://user-images.githubusercontent.com/32811372/207320917-f7fd5d5e-1442-4440-8341-c1646593418e.png)
3. 在某些具有怀聚精神的人眼里，用两根信号线来接受外部设备中断可能是多余的。也许只需要一根就可以了。这似乎有些道理，但是，来自外部设备的中断很多，也不是每一个中断都是必须处理的。有些中断，在任何时候都必须及时处理，因为事关整个系统的安全性。比如，在使用不间断电源的系统中，当电池电量很低的时候，不间断电源系统会发出一个中断，通知处理器快掉电了。再比如，内存访问电路发现了一个校验错误，这意味着，从内存读取的数据是错误的，处理器再努力工作也是没有意义的。在所有这些情况下，处理器必须针对这些中断采取必要的措施，隐瞒真相必然会对用户造成不可挽回的损失。除此之外，更多的中断是可以被忽略或者延迟处理的，如果某个程序希望不被打扰的话。
4. （非屏蔽中断）在这种情况下，处理器的设计者希望通过两个引脚来明确区分不同性质的中断，这是很自然的事。首先，所有的严重事件都必须无条件地加以处理，这种类型的中断是不会被阻断和屏蔽的。称为非屏蔽中断（Non Maskable Intermupt, NMI)。
5. 当一个中断发生时，处理器将会通过中断引脚 NMI 和 INTR 得到通知。除此之外，它还应当知道发生了什么事，以便采取适当的处理措施。每种类型的中断都被统一编号，这称为中断类型号、中断向量或者中断号。但是，由于不可屏敞中断的特殊性————几乎所有触发 NMI 的事件对处理器来说都是致命的，甚至是不可纠正的。在这种情况下，努力去搞清楚发生了什么，通常没有太大的意义，这样的事最好留到事后，让专业维修人员来做。也正是这个原因，在实模式下，NMI 被赋予了统一的中断号 2，不再进行细分。一旦发生了 2 号中断，处理器和软件系统通常会放弃维续正常工作的“念头”，也不会试图纠正已经发生的问题和错误，很可能只是由软件系统给出一个提示信息。
6. （可屏蔽中断）和 NMI 不同，更多的时候，发往处理器的中断信号通常不会意味着灾难。当然，有时候也会非常紧急，比如，在一个由计算机控制的车床上，当零件快速通过铣具时，处理器应当立即处理中断，并向铣具发送信号，告诉它应当如何切削。这类中断有两个特点，第一是数量很多，毕竟有很多外部设备：第二是它们可以被屏蔽，这样处理器就像是没听见、没看见一样，不会对它们进行处理。所以，这类硬件中断称为可屏蔽中断。尽管不处理中断就会把零件铣坏，但是否允许处理器看见该中断，是你自己的事，这是处理器赋予你的权利。
7. （8259 芯片、可编程中断控制器 PIC）可屏蔽中断是通过 TNTR 引脚进入处理器内部的，像 NMI 一样，不可能为每一个中断源都提供一个引脚。而且，处理器每次只能处理一个中断。在这种情况下，需要一个代理，来接受外部设备发出的中断信号。还有，多个设备同时发出中断请求的几率也是很高的，所以该代理的任务还包括对它们进行件裁，以决定让它们中的哪一个优先向处理器提出服务请求。如图下图所示，在个人计算机中，用得最多的中断代理就是 8259 芯片，它就是通常所说的中断控制器，从 8086 处理器开始，它就一直提供着这种服务。即使是现在，在绝大多数单处理器的计算机中，也依然有它的存在。Intel 处理器允许 256 个中断，中断号的范围是 0～255，8259 负责提供其中的 15 个，但中断号并不固定。之所以不固定，是因为当初设计的时候，允许软件根据自己的需要灵活设置中断号，以防止发生冲突。该中断控制器芯片有自己的端口号，可以像访问其他外部设备一样用 in 和 out 指令来改变它的状态，包括各引脚的中断号。正是因为这样，它又叫可编程中断控制器 (Pogrammable Interrupt Controller, PIC)。不知道是怎么想的，反正每片 8259 只有 8 个中断输入引脚，而在个人计算机上使用它，需要两块。如图下图所示，第一块 8259 芯片的代理输出 INT 直接送到处理器的 INTR 引脚，这是主片(Master)；第二块 8259 芯片的 INT 输出送到第一块的引脚 2 上，是从片（Slave)，两块芯片之间形成级联（Cascade）关系。如此一来，两块 8259 芯片可以向处理器提供 15 个中断信号。当时，接在 8259 上的 15 个设备都是相当重要的，如 PS/2 键盘和鼠标、串行口、并行口、软磁盘驱动器、IDE 硬盘等。现在，这些设备很多都已淘汰或者正在淘汰中，根据需要，这些中断引脚可以被其他设备使用。
![image](https://user-images.githubusercontent.com/32811372/207327307-d0943984-159d-4ad7-af4d-764ad84dbefd.png)
8. 如上图所示，8259 的主片引脚 0（IRO）接的是系统定时器/计数器芯片；从片的引脚 0（IRO）接的是实时时钟芯片 RTC，该芯片是本章的主角，很快就会讲到。总之，这两块芯片的固定连接即使是在硬件更新换代非常频繁的今天，也依然没有改变。
9. （中断屏蔽寄存器）在8259 芯片内部，有中断屏蔽寄存器（Interrupt Mask Register，IMR)，这是个 8 位寄存器，对应着该芯片的 8 个中断输入引脚，对应的位是 0 还是 1，决定了从该引脚来的中断信号是否能够通过 8259 送往处理器（0 表示允许，1 表示阻断，这可能出乎你的意料)。当外部设备通过某个引脚送来一个中断请求信号时，如果它没有被 IMR 阻断，那么，它可以被送往处理器。注意，8259 芯片是可编程的，主片的端口号是 0x20 和 0x21，从片的端口号是 0xa0 和 0xa1，可以通过这些端口访问 8259 芯片，设置它的工作方式，包括 IMR 的内容。
10. 中断能否被处理，除了要看 8259 芯片的脸色外，最终的决定权在处理器手中。在处理器内部，标志寄存器有一个标志位 IF，这就是中断标志 (Interrupt Flag)。当 IF 为 0时，所有从处理器 INTR 引脚来的中断信号都被忽略掉：当其为 1 时，处理器可以接受和响应中断。
11. IF 标志位可以通过两条指令 cli 和 sti 来改变。这两条指令都没有操作数。cli（CLear Interrupt flag）用于清除 IF 标志位，sti（Set Interrupt flag）用于置位 IF 标志。
12. 在计算机内部，中断发生得非常频繁，当一个中断正在处理时，其他中断也会陆续到来。甚至会有多个中断同时发生的情况，这都无法预料。不用担心，8259 芯片会记住它们。并按一定的策略决定先为谁服务。总体上来说，中断的优先级和引脚是相关的，主片的 IRO 引脚优先级最高，IR7引脚最低，从片也是如此。当然，还要考虑到从片是级联在主片的 IR2 引脚上。
13. 当一个中断事件正在处理时，如果来了一个优先级更高的中断事件时，允许暂时中止当前的中断处理，先为优先级较高的中断事件服务，这称为中断嵌套。

## 中断处理
1. （中断处理、中断向量表）所谓中断处理，归根结底就是处理器要执行一段与该中断有关的程序（指令)。处理器可以识别 256 个中断，那么理论上就需要 256 段程序。这些程序的位置并不重要，重要的是，在实模式下，处理器要求将它们的入口点集中存放到内存中从物理地址 0x00000 开始，到 0x003f结束，共 1KB 的空间内，这就是所谓的中断向量表（Interrupt Vector Table，IVT)。
2. 如下图所示，每个中断在中断向量表中占 2 个字，分别是中断处理程序的偏移地址和段地址。中断 0 的入口点位于物理地址 0x00000 处，也就是逻辑地址 0x0000:0x0000；中断 1 的入口点
位于物理地址 0x00004 处，即逻辑地址 0x0000:0x0004；其他中断以此类推，总之是按顺序的。
![image](https://user-images.githubusercontent.com/32811372/207490323-107f540f-824f-4439-8ad7-134c00fdb8d1.png)
3. 当中断发生时，如果从外部硬件到处理器之间的道路都是畅通的，那么，处理器在执行完当前的指令后，会立即着手为硬件服务。它首先会响应中断，告诉 8259 芯片准备着手处理该中断。接着，它还会要求 8259 芯片把中断号送过来。在 8259 芯片那里，每个引脚都赋予了一个中断号。而且，这些中断号是可以改变的，可以对 8259 编程来灵活设置，但不能单独进行，只能以芯片为单位进行。比如，可以指定主片的中断号从 0x08 开始，那么它每个引脚 IRO～IR7 所对应的中断号分别是 x08～0x0e。
4. 中断信号来自哪个引脚，8259 芯片是最清楚的，所以它会把对应的中断号告诉处理器，处理器拿着这个中断号，要顺序做以下几件事：
    1. 保护断点的现场。首先要将标志寄存器 FLAGS 压栈，然后清除它的 IF 位和 TF 位。TF 是陷阱标志，这个以后再讲。接着，再将当前的代码段寄存器 CS 和指令指针寄存器 IP 压栈。
    2. 执行中断处理程序。由于处理器已经拿到了中断号，它将该号码乘以 4（毕竟每个中断在中断向量表中占 4 字节)，就得到了该中断入口点在中断向量表中的偏移地址。接着，从表中依次取出中断程序的偏移地址和段地址，并分别传送到 IP 和 CS，自然地，处理器就开始执行中断处理程序了。
    3. 注意，由于 IF 标志被清除，在中断处理过程中，处理器将不再响应硬件中断。如果希望更高优先级的中断嵌套，可以在编写中断处理程序时，适时用 sti 指令开放中断。
    4. 返回到断点接着执行。所有中断处理程序的最后一条指令必须是中断返回指令 iet。这将导致处理器依次从栈中弹出（恢复）IP、CS 和 FLAGS 的原始内容，于是转到主程序接着执行。
    5. 顺便提醒一句，由于中断处理过程返回时，已经恢复了 FLAGS 的原始内容，所以 IF 标志位也自动恢复。也就是说，可以接受新的中断。
    6. 和可屏蔽中断不同，NMI 发生时，处理器不会从外部获得中断号，它自动生成中断号码 2。其他处理过程和可屏蔽中断相同。
    7. 中断随时可能发生，中断向量表的建立和初始化工作是由 BIOS 在计算机启动时负责完成的。BIOS 为每个中断号填写入口地址，因为它不知道多数中断处理程序的位置，所以，一律将它们指向一个相同的入口地址，在那里，只有一条指令：iret。也就是说，当这些中断发生时，只做一件事，那就是立即返回。当计算机启动后，操作系统和用户程序再根据自己的需要，来修改某些中断的入口地址，使它指向自己的代码。

  





# 内部中断
# 软中断
